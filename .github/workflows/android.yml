name: Build VPN BRI - Fixed & Optimized

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
  # RAM diatur 5GB agar sisa 1GB untuk OS GitHub biar gak crash
  GRADLE_OPTS: "-Xmx5000m -Xms2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled -XX:+AlwaysPreTouch"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Clean Gradle Cache
      run: |
        rm -rf ~/.gradle/caches
        rm -rf ${{ github.workspace }}/.gradle
        echo "✓ Gradle cache cleared"

    - name: Download libv2ray.aar with Retry
      run: |
        set -e
        RETRY_COUNT=0
        MAX_RETRIES=3
        DOWNLOAD_URL="https://github.com/2dust/AndroidLibXrayLite/releases/latest/download/libv2ray.aar"
        
        mkdir -p V2rayNG/app/libs
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Download attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
          if curl -L --fail --show-error \
            --connect-timeout 30 \
            --max-time 300 \
            --retry 2 \
            "$DOWNLOAD_URL" \
            -o V2rayNG/app/libs/libv2ray.aar; then
            
            FILE_SIZE=$(stat -c%s "V2rayNG/app/libs/libv2ray.aar" 2>/dev/null || echo "0")
            if [ "$FILE_SIZE" -gt 5000000 ]; then
              echo "✓ libv2ray.aar downloaded successfully (Size: $FILE_SIZE bytes)"
              exit 0
            else
              echo "✗ Downloaded file too small - corrupted"
              rm -f V2rayNG/app/libs/libv2ray.aar
            fi
          fi
          RETRY_COUNT=$((RETRY_COUNT + 1))
          sleep 10
        done
        exit 1

    - name: Verify & Prepare Gradle
      run: |
        if [ ! -f "V2rayNG/gradlew" ]; then
          echo "✗ gradlew not found in V2rayNG/"
          ls -R
          exit 1
        fi
        chmod +x V2rayNG/gradlew
        echo "✓ gradlew ready"

    - name: Configure Gradle Properties
      run: |
        mkdir -p ~/.gradle
        cat > ~/.gradle/gradle.properties << 'INNEREOF'
        org.gradle.jvmargs=-Xmx5000m -Xms2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200
        org.gradle.parallel=true
        org.gradle.workers.max=4
        org.gradle.caching=true
        android.useAndroidX=true
        android.enableJetifier=true
        android.suppressUnsupportedCompileSdkWarning=true
        INNEREOF

    - name: Build APK (fdroid Debug)
      working-directory: ./V2rayNG
      run: |
        echo "Starting build..."
        ./gradlew clean assembleFdroidDebug \
          --no-daemon \
          --stacktrace \
          --build-cache \
          -Porg.gradle.jvmargs="-Xmx5000m" 2>&1 | tee build.log
        
        BUILD_STATUS=${PIPESTATUS[0]}
        if [ $BUILD_STATUS -eq 0 ]; then
          echo "✓ Success"
        else
          echo "✗ Failed. Last logs:"
          tail -n 100 build.log
          exit 1
        fi

    - name: Upload APK
      if: success()
      uses: actions/upload-artifact@v6
      with:
        name: VPN-BRI-V34-FINAL
        path: V2rayNG/app/build/outputs/apk/fdroid/debug/*.apk

    - name: Upload Error Logs
      if: failure()
      uses: actions/upload-artifact@v6
      with:
        name: Build-Error-Log
        path: V2rayNG/build.log
