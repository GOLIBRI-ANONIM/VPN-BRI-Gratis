name: Build VPN BRI - Fixed & Optimized

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  GRADLE_USER_HOME: ${{ github.workspace }}/.gradle
  GRADLE_OPTS: "-Xmx5500m -Xms2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled -XX:+AlwaysPreTouch"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'
        cache: 'gradle'

    - name: Clean Gradle Cache (Fix Build Issues)
      run: |
        rm -rf ~/.gradle/caches
        rm -rf ${{ github.workspace }}/.gradle
        echo "✓ Gradle cache cleared"

    - name: Download libv2ray.aar with Retry
      run: |
        set -e
        RETRY_COUNT=0
        MAX_RETRIES=3
        DOWNLOAD_URL="https://github.com/2dust/AndroidLibXrayLite/releases/latest/download/libv2ray.aar"
        
        mkdir -p V2rayNG/app/libs
        
        while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
          echo "Download attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
          if curl -L --fail --show-error \
            --connect-timeout 30 \
            --max-time 300 \
            --retry 2 \
            "$DOWNLOAD_URL" \
            -o V2rayNG/app/libs/libv2ray.aar; then
            
            FILE_SIZE=$(stat -c%s "V2rayNG/app/libs/libv2ray.aar" 2>/dev/null || echo "0")
            if [ "$FILE_SIZE" -gt 5000000 ]; then
              echo "✓ libv2ray.aar downloaded successfully (Size: $FILE_SIZE bytes)"
              exit 0
            else
              echo "✗ Downloaded file too small (Size: $FILE_SIZE bytes) - corrupted download"
              rm -f V2rayNG/app/libs/libv2ray.aar
            fi
          fi
          
          RETRY_COUNT=$((RETRY_COUNT + 1))
          if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
            echo "Waiting 15 seconds before retry..."
            sleep 15
          fi
        done
        
        echo "✗ Failed to download libv2ray.aar after $MAX_RETRIES attempts"
        exit 1

    - name: Verify Gradle Wrapper
      run: |
        if [ ! -f "V2rayNG/gradlew" ]; then
          echo "✗ Gradle wrapper not found!"
          exit 1
        fi
        chmod +x V2rayNG/gradlew
        echo "✓ Gradle wrapper verified"

    - name: Configure Gradle Properties
      run: |
        mkdir -p ~/.gradle
        cat > ~/.gradle/gradle.properties << 'INNEREOF'
        # JVM Memory Configuration (5.5GB Max)
        org.gradle.jvmargs=-Xmx5500m -Xms2g -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:+ParallelRefProcEnabled -XX:+AlwaysPreTouch
        
        # Build Performance
        org.gradle.parallel=true
        org.gradle.workers.max=4
        org.gradle.caching=true
        org.gradle.vfs.watch=false
        
        # Kotlin Optimization
        kotlin.incremental=true
        kotlin.compiler.execution.strategy=in-process
        
        # Android Optimization  
        android.dexOptions.incremental=true
        android.useAndroidX=true
        android.enableBuildCache=true
        android.generateSyncIssueWhenLibraryConstraintsAreEnabled=false
        
        # Suppress Deprecation Warnings
        android.suppressUnsupportedCompileSdkWarning=true
        INNEREOF
        
        echo "✓ Gradle properties configured"

    - name: Build APK (fdroid Debug)
      working-directory: ./V2rayNG
      run: |
        echo "Starting build process..."
        ./gradlew clean assembleFdroidDebug \
          --no-daemon \
          --stacktrace \
          --build-cache \
          --parallel \
          -P org.gradle.jvmargs="-Xmx5500m" 2>&1 | tee build.log
        
        BUILD_STATUS=${PIPESTATUS[0]}
        if [ $BUILD_STATUS -eq 0 ]; then
          echo "✓ Build completed successfully"
          exit 0
        else
          echo "✗ Build failed with status code $BUILD_STATUS"
          echo "---"
          echo "Last 100 lines of build log:"
          tail -100 build.log
          exit 1
        fi

    - name: Verify APK Output
      if: success()
      run: |
        APK_PATH="V2rayNG/app/build/outputs/apk/fdroid/debug/"
        if [ -d "$APK_PATH" ]; then
          APK_COUNT=$(find "$APK_PATH" -name "*.apk" 2>/dev/null | wc -l)
          if [ $APK_COUNT -gt 0 ]; then
            echo "✓ Found $APK_COUNT APK file(s)"
            find "$APK_PATH" -name "*.apk" -exec ls -lh {} \;
          else
            echo "✗ No APK files found in $APK_PATH"
            exit 1
          fi
        else
          echo "✗ Output directory not found: $APK_PATH"
          exit 1
        fi

    - name: Upload APK on Success
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: VPN-BRI-V33-SUCCESS
        path: V2rayNG/app/build/outputs/apk/fdroid/debug/*.apk
        retention-days: 30
        if-no-files-found: error

    - name: Upload Build Logs on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Build-Failure-Reports
        path: |
          V2rayNG/app/build/reports/
          V2rayNG/build/reports/
          V2rayNG/build.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Build Status Summary
      if: always()
      run: |
        echo "========================================="
        if [ "${{ job.status }}" == "success" ]; then
          echo "✅ BUILD SUCCESSFUL"
          echo "APK is ready for testing/deployment"
        else
          echo "❌ BUILD FAILED"
          echo "Check artifact logs for details"
        fi
        echo "========================================="
